#!/bin/bash -xev

# Do some chef pre-work
/bin/mkdir -p /etc/chef
/bin/mkdir -p /var/lib/chef
/bin/mkdir -p /var/log/chef

# Setup hosts file correctly
cat >> "/etc/hosts" << EOF
54.193.50.33 chef-server chef-server.raco.int
EOF

cd /etc/chef/

# Install chef
curl -L https://omnitruck.chef.io/install.sh | bash || error_exit 'could not install chef'

# Create first-boot.json
FIRST_BOOT="/etc/chef/first-boot.json"
cat > "$FIRST_BOOT" << EOF
{
   "run_list" :[
      "role[web-server]"
   ]
}
EOF

GUID=$(printf '%x\n' $(date +%s))
NODE_TYPE="web-server"
NODE_NAME="$NODE_TYPE-$GUID"

# Create client.rb
CLIENT_RB="/etc/chef/client.rb"
/bin/echo 'log_location     STDOUT' >> $CLIENT_RB
/bin/echo -e "chef_server_url  'https://ec2-54-193-50-33.us-west-1.compute.amazonaws.com/organizations/raco'" >> $CLIENT_RB
/bin/echo -e "validation_client_name 'raco-validator'" >> $CLIENT_RB
/bin/echo -e "node_name  '${NODE_NAME}'" >> $CLIENT_RB

# Get validation.pem (yeah, i know, this it totally not secure)
aws s3 cp s3://raco/chef/validation.pem /etc/chef/validation.pem

# Run chef-client
sudo chef-client -j $FIRST_BOOT
