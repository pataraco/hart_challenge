{
   "AWSTemplateFormatVersion" : "2010-09-09",
   "Description" : "Create infrastructure for Auto Web Server exercise",
   "Parameters" : {
      "Creator" : {
         "Description": "Name of person creating the infrastructure",
         "Type" : "String",
         "Default": "raco"
      }
   },
   "Resources" : {
      "VPC" : {
         "Type" : "AWS::EC2::VPC",
         "Properties" : {
            "CidrBlock" : "8.12.0.0/16",
   	    "EnableDnsSupport" : "false",
   	    "EnableDnsHostnames" : "false",
            "InstanceTenancy" : "default",
            "Tags" : [ {"Key" : "Name", "Value" : {"Ref": "Creator"} } ]
         }
      },
      "SubnetInt1" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {"Ref": "VPC"},
            "CidrBlock" : "8.12.1.0/24",
            "AvailabilityZone" : "us-west-1a",
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-int-usw-1a"]]} } ]
         }
      },
      "SubnetInt2" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {"Ref": "VPC"},
            "CidrBlock" : "8.12.3.0/24",
            "AvailabilityZone" : "us-west-1b",
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-int-usw-1b"]]} } ]
         }
      },
      "SubnetExt1" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {"Ref": "VPC"},
            "CidrBlock" : "8.12.2.0/24",
            "AvailabilityZone" : "us-west-1a",
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-ext-usw-1a"]]} } ]
         }
      },
      "SubnetExt2" : {
         "Type" : "AWS::EC2::Subnet",
         "Properties" : {
            "VpcId" : {"Ref": "VPC"},
            "CidrBlock" : "8.12.4.0/24",
            "AvailabilityZone" : "us-west-1b",
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-ext-usw-1b"]]} } ]
         }
      },
      "IGW" : {
         "Type" : "AWS::EC2::InternetGateway",
         "Properties" : {
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-igw"]]} } ]
         }
      },
      "AttachIGW" : {
         "Type" : "AWS::EC2::VPCGatewayAttachment",
         "Properties" : {
            "VpcId" : { "Ref" : "VPC" },
            "InternetGatewayId" : { "Ref" : "IGW" }
         }
      },
      "NGW" : {
         "Type" : "AWS::EC2::NatGateway",
         "Properties" : {
            "AllocationId" : { "Fn::GetAtt" : ["NGWEIP", "AllocationId"]},
            "SubnetId" : { "Ref" : "SubnetExt1"},
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-ngw"]]} } ]
         }
      },
      "NGWEIP" : {
         "Type" : "AWS::EC2::EIP",
         "Properties" : {
            "Domain" : "vpc"
         }
      },
      "RouteTableInt" : {
         "Type" : "AWS::EC2::RouteTable",
         "Properties" : {
            "VpcId" : { "Ref" : "VPC" },
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-rtbl-int"]]} } ]
         }
      },
      "RouteTableExt" : {
         "Type" : "AWS::EC2::RouteTable",
         "Properties" : {
            "VpcId" : { "Ref" : "VPC" },
            "Tags" : [ { "Key" : "Name", "Value" : {"Fn::Join": ["", [{"Ref": "Creator"}, "-rtbl-ext"]]} } ]
         }
      },
      "RouteIntOut" : {
         "Type" : "AWS::EC2::Route",
         "Properties" : {
           "DestinationCidrBlock" : "0.0.0.0/0",
           "NatGatewayId" : { "Ref" : "NGW" }
           "RouteTableId" : { "Ref" : "RouteTableInt" }
         }
      },
      "RouteExtOut" : {
         "Type" : "AWS::EC2::Route",
         "Properties" : {
           "DestinationCidrBlock" : "0.0.0.0/0",
           "GatewayId" : { "Ref" : "IGW" }
           "RouteTableId" : { "Ref" : "RouteTableInt" }
         }
      }
   }
}     
